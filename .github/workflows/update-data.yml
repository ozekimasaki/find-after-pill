name: Update Pharmacy Data

"on":
  schedule:
    # 毎日 UTC 21:00 (日本時間 6:00) に実行
    - cron: '1 21 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch and convert Excel data
        run: npm run fetch-data
        env:
          # ジオコーディングの全件処理を有効化
          GEOCODE_ALL: 'true'

      - name: Upload pharmacies data to KV
        run: |
          npx wrangler kv key put \
            --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
            --remote \
            pharmacies \
            --path=public/data/pharmacies.json
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Upload meta data to KV
        run: |
          npx wrangler kv key put \
            --namespace-id=${{ secrets.KV_NAMESPACE_ID }} \
            --remote \
            meta \
            --path=public/data/meta.json
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Summary
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat public/data/meta.json | jq -r '"- **Total pharmacies**: \(.totalCount)"' >> $GITHUB_STEP_SUMMARY
          cat public/data/meta.json | jq -r '"- **Last updated**: \(.lastUpdated)"' >> $GITHUB_STEP_SUMMARY
          cat public/data/meta.json | jq -r '"- **Source**: \(.sourceUrl)"' >> $GITHUB_STEP_SUMMARY
